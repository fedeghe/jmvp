/*
mvp v.1.0.0
An experimental microframework using the mvp
Federico Ghedina <fedeghe@gmail.com>
License: MIT
size: ~9KB
*/
!function(W){"use strict";function getRouteApp(t){var e,n={route:{},app:{}};for(e in t)t.hasOwnProperty(e)&&(n.route[t[e].route]=e,n.app[e]=t[e].route);return n}function App(t,e){this.presenter=t;var n;for(n in e)e.hasOwnProperty(n)&&"init"!==n&&this._addSetup(n,e[n]);"init"in e&&e.init.call(this.presenter),this._setups=e,this._routesApp=getRouteApp(e),this.trg=null,this._initPopState()}function Model(t){this._data=Object.assign({},t),this._auto()}function notValidModel(t,e){if(t.match(/_setter|_getter|_data|_auto|defineMethod/))throw new Error("Forbidden "+e+' "'+t+'"')}function View(t,e){this.cnt=document.createElement("div"),this.tpl=t.replace(/\r?\n|\r|\t|\s\s/gm,""),this.cnt.innerHTML=this.tpl,this.node=this.cnt.childNodes[0],this.childs=[],this.model=e?Object.assign({},e):null,this.handlers=[],this.model&&this.setModel(this.model),this.cache={}}function Presenter(t,e){this.model=t||null,this.view=e||null,this.trg=null,this._definedMethods={},this._setups={},this.active=!0,this._handlersResetFuncs=[]}var jmvp={};jmvp.utils={},jmvp.utils.ucfirst=function(t){return t.slice(0,1).toUpperCase()+t.slice(1)},jmvp.extends=function(t,e){function n(){}n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.superClass=e.prototype,t.baseConstructor=e,t.super=function(t){var n=[].slice.call(arguments,1);e.apply(t,n)}},App.prototype._initPopState=function(){var t=this;window.addEventListener("popstate",function(){var e=window.location.pathname;e in t._routesApp.route&&t[t._routesApp.route[e]]()})},App.prototype._addSetup=function(t,e){App.prototype[t]=function(n){n&&n.trg&&(this.trg=n.trg);var i=JMVP.Presenter(),o="defs"in e,r="init"in e,s="function"==typeof e.model?e.model(n):e.model,h="function"==typeof e.view?e.view(n):e.view,u=i(s,h);return App.prototype[t].presenter=u,h.setModel(s),u.model||u.setModel(u.view.model),r&&(u.init=function(){e.init.call(u,n)}),o&&(u.defs=function(){e.defs.call(u,n)}),n.append||(this.trg.innerHTML=""),u.render.call(u,this.trg),u}},App.getRouteApp=function(t){var e,n={route:{},app:{}};for(e in t)t.hasOwnProperty(e)&&(n.route[t[e].route]=e,n.app[e]=t[e].route);return n},Model.prototype._get=function(t){return this._data[t]||null},Model.prototype._has=function(t){return t&&t in this._data},Model.prototype._auto=function(){var t,e=this._data,n=this;for(t in e)e.hasOwnProperty(t)&&"string"==typeof t&&(n._getter(t),n._setter(t))},Model.prototype._setter=function(t){notValidModel(t,"setter");var e=this;e["set"+jmvp.utils.ucfirst(t)]=function(n,i){var o=i?i.bind(e):function(){};e._data[t]=n,o&&o(t,n)}},Model.prototype._getter=function(t){var e=this;notValidModel(t,"getter"),e["get"+jmvp.utils.ucfirst(t)]=function(){return e._data[t]}},Model.prototype.getData=function(){return this._data},Model.prototype.defineMethod=function(t,e){notValidModel(t,"method"),this.constructor.prototype[t]=e},View.prototype._refs=function(){!function t(e,n){var i,o=0,r=e.childNodes,s=r.length;for(null;o<s;o++)i={node:r[o],childs:[]},n.push(i),t(r[o],i.childs)}(this.node,this.childs)},View.prototype.setModel=function(model){this.reset(),this.model=model;var tpl=this.tpl.replace(/\$\[([^\]]*)\]/gm,function(t,e){return model._data[e]}).replace(/\{([^}]*)\}/gm,function(a,b){return eval("("+b+")")});this.cnt.innerHTML=tpl,this.node=this.cnt.childNodes[0],this._refs()},View.prototype.reset=function(){for(var t=0,e=this.handlers.length;t<e;t++)this.handlers[t].call(this);this.handlers=[],this.childs=[]},View.prototype.setHandler=function(t,e,n){var i,o;try{o=this.getNode.apply(this,t)}catch(t){console.log(t)}return!!o&&(o.addEventListener(e,n),i=function(){o.removeEventListener(e,n)},this.handlers.push(i),i)},View.prototype.defineMethod=function(t,e){this.constructor.prototype[t]=e},View.prototype.getNode=function(){var t=[].slice.call(arguments),e=this,n=0,i=t.length,o=this.childs;for(null;n<i;n++){if(!(e=o[t[n]]))throw new Error(t+" not found, handler not settable");o=e.childs}return e&&e.node},Presenter.prototype.init=function(){},Presenter.prototype.setView=function(t){this.view=t},Presenter.prototype.setModel=function(t){this.model=t},Presenter.prototype.reset=function(t){try{t&&this._resetDefineMethod(),this._resetHandlers(),this.view.reset(),this.model=null,this.view=null}catch(t){return!1}return!0},Presenter.prototype._resetHandlers=function(){for(var t=0,e=this._handlersResetFuncs.length;t<e;t++)this._handlersResetFuncs[t]()},Presenter.prototype.setHandler=function(){var t=this.view.setHandler.apply(this.view,arguments);t&&this._handlersResetFuncs.push(t)},Presenter.prototype.getNode=function(){return this.view.getNode.apply(this.view,arguments)},Presenter.prototype._resetDefineMethod=function(){for(var t in this._definedMethods)delete this._definedMethods[t];this._definedMethods={}},Presenter.prototype.defineMethod=function(t,e){this.constructor.prototype[t]=e,this._definedMethods[t]=!0},Presenter.prototype.render=function(t){if(!this.view)throw new Error("ERROR: presenter with no view");if(!this.view.model)throw new Error("ERROR: view with no model");this.trg=t,this.defs&&this.defs.call(this),this.init&&this.init.call(this),this.active&&t.appendChild(this.getNode())},Presenter.prototype.stop=function(){this.active=!1},Presenter.prototype.refresh=function(){var t=this.getNode();this.view.setModel(this.model),this.setModel(this.model),this.setView(this.view),this.view.reset(),this.view._refs(),this.trg.replaceChild(this.view.node,t),this.defs&&this.defs.call(this),this.init&&this.init.call(this)},Presenter.prototype.getSetupsManager=function(t){return this._setups=Object.assign(this._setups,t),new App(this,t)};var NS={};"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");var n,i,o,r=Object(t);for(n=1;n<arguments.length;n++)if(null!=(i=arguments[n]))for(o in i)Object.prototype.hasOwnProperty.call(i,o)&&(r[o]=i[o]);return r},writable:!0,configurable:!0}),NS.Model=function(t){function e(e){this._data=e||t}return jmvp.extends(e,Model),function(n){var i=new e(n||t);return e.super(i,n||t),i}},NS.View=function(t,e){function n(e){this.tpl=e||t}return jmvp.extends(n,View),function(e,i){var o=new n(e||t,i);return n.super(o,e||t,i),o}},NS.Presenter=function(t,e){function n(t,e){this.model=t,this.view=e}return jmvp.extends(n,Presenter),function(i,o){i=i||t,o=o||e;var r=new n(i,o);return n.super(r,i,o),r}},NS.util={},NS.util.toQs=function(t,e){var n,i,o=[];for(n in t)if(t.hasOwnProperty(n)){if((t[n]+"").match(/\{.*\}/))for(i in e)t[n]=(""+t[n]).replace("{"+i+"}",encodeURIComponent(e[i]));o.push(n+"="+encodeURIComponent(t[n]))}return"?"+o.join("&")},NS.util.toMemFormat=function(t,e){if(!t)return t+(e||"");for(var n=["","K","M","G","T","P","E","Z","Y"],i=0;t/Math.pow(1024,i+1)>1;)i++;return""+(t/Math.pow(1024,i)).toFixed(2).replace(/\.?0+$/,"")+n[i]+(e||"")},NS.util.dateFormat=function(t){return new Date(t).toLocaleString(navigator.language)},NS.events={},NS.events.ready=function(){var t=[],e=setInterval(function(){if("complete"===document.readyState){clearInterval(e);for(var n=0,i=t.length;n<i;n++)t[n].call(this)}},10);return function(e){"complete"===document.readyState?e.call(this):t.push(e)}}(),NS.events.getOffset=function(t,e){t=t||window.event;var n=e||t.target||t.srcElement,i=NS.events.coord(t),o=n.getBoundingClientRect();return[i[0]-o.left,i[1]-o.top]},NS.events.coord=function(t){var e,n,i,o=window.document;return i=t.touches&&t.touches.length?t.touches[0]:t,i.pageX||i.pageY?(e=i.pageX,n=i.pageY):(e=i.clientX+o.body.scrollLeft+o.documentElement.scrollLeft,n=i.clientY+o.body.scrollTop+o.documentElement.scrollTop),[e,n]},NS.storage=function(t){var e="localStorage",n={localStorage:1,sessionStorage:1};return{set:function(n,i,o){t[o||e].setItem(n,i)},get:function(n,i){return t[i||e].getItem(n)},remove:function(n,i){t[i||e].removeItem(n)},clear:function(n){t[n||e].clear()},use:function(t){t in n&&(e=t)}}}(window),function(){function t(){return{}}function e(t,e,n){var i=t.states.length,o=t.states[i-1];t.listeners.forEach(function(t){t(o,e,n)}),t.states[i]=e}function n(e,n){this.reducer=e||t,this.state=n||this.reducer(),this.states=[this.state],this.listeners=[]}n.prototype.getState=function(){return this.states[this.states.length-1]},n.prototype.dispatch=function(t){if(!("type"in t))throw new Error("Actions needs a type");var n,i=t.type,o=this.states[this.states.length-1],r=this.reducer(o,i);for(n in t)"type"!==n&&(r[n]=t[n]);e(this,r,i)},n.prototype.subscribe=function(t){var e,n=this;return this.listeners.push(t),e=this.listeners.length-1,function(){n.listeners=n.listeners.slice(0,e).concat(n.listeners.slice(e+1))}},n.prototype.all=function(){return this.states.concat()},n.prototype.back=function(t){var n=this.states.length-1,i=n-t,o=i>-1?i:0;e(this,this.states[o])},NS.getStore=function(t,e){return new n(t,e)}}(),W.JMVP=NS}(window);